@model fmis.Models.Accounting.IndexOfPayment

<link rel="stylesheet" href="~/assets/plugin/daterangepicker/daterangepicker.css">
<script src="~/assets/plugin/daterangepicker/moment.min.js"></script>
<script src="~/assets/plugin/daterangepicker/daterangepicker.js"></script>
<style>
    .select2 {
        width: 100% !important;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
</style>
<button type="button" style="margin-right:15px; margin-top: 10px;" class="close" data-dismiss="modal">×</button>
<center><h3 class="grey lighter smaller">Create Index of Payment </h3></center>
<hr />
<div class="container" style="height: 840px;">
    <form asp-action="Create" style="position:center;">
        <div class="col-md-12">
            <div class="col-md-3">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="form-group">
                    <label asp-for="Category" class="control-label"></label>
                    <select class="form-control select2" asp-for="CategoryId" asp-items="ViewBag.CategoryId">
                        <option> - Select Category - </option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Dv" class="control-label"></label>

                        @*<select class="form-control select2" asp-for="DvId" asp-items="ViewBag.DvId">

                            <option> - Select Dv # - </option>
                        </select>*@
                        @Html.DropDownList("DvId", null, htmlAttributes: new { @class = "prexcDropdown form-control",    @id = "ddlBranches", onchange = "return get_sbu(this)" })
                        @if(ViewBag.Message != null && ViewBag.Message == "Exist"){
                            <br /><span style="color:red;">Already exist.</span>
                        }
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>PAYEE :</label>

                        <input id="payeeDesc" class="form-control" readonly />
                    </div>
                </div>
            </div>
            <div>
                <div class="col-md-3">
                    <label>DATE:</label>
                    <input asp-for="DvDate"  onchange="getFormattedDate" class="form-control">
                    <span class="text-danger"></span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label>PARTICULARS:</label>
                    <textarea asp-for="Particulars" id="particulars" style="height: 70px;" class="form-control"></textarea>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="col-md-3" name="hidden-panel1" id="hidden-panel1">
                <div class="form-group">
                    <label>PO #:</label>
                    <input asp-for="PoNumber" id="poNumber" type="text" class="form-control" onchange="DataCheck()" />
                </div>
                <div class="row">
                <label class="col-sm-2"></label>
                    <div class="col-sm-10">
                    <p id="Status" />
                    </div>
                </div>
            </div>
            <div class="col-md-3" name="hidden-panel2" id="hidden-panel2">
                <div class="form-group">
                    <label>PROJECT ID:</label>
                    <input asp-for="ProjectId" id="project"  class="form-control" onchange="ProjectCheck()"/>
                </div>
                <div class="row">
                <label class="col-sm-2"></label>
                    <div class="col-sm-10">
                    <p id="ProjectCheck" />
                    </div>
                </div>
            </div>
            <div class="col-md-3" name="hidden-panel5" id="hidden-panel5">
                <div class="form-group">
                    <label>INVOICE #:</label>
                    <input asp-for="InvoiceNumber" id="invoice" type="text" class="form-control" onchange="InvoiceCheck()" />
                </div>
                <div class="row">
                <label class="col-sm-2"></label>
                    <div class="col-sm-10">
                    <p id="InvoiceCheck" />
                    </div>
                </div>
            </div>
            <div class="col-md-3" name="hidden-panel4" id="hidden-panel4">
                <div class="form-group">
                    <label>PERIOD COVER</label>
                    <input type="month" asp-for="PeriodCover" id="periodCover" class="form-control" onchange="PeriodCheck()">
                </div>
                <div class="row">
                <label class="col-sm-2"></label>
                    <div class="col-sm-10">
                    <p id="PeriodCheck" />
                    </div>
                </div>
            </div>
            <div class="col-md-3" name="hidden-panel6" id="hidden-panel6">
                <div class="form-group">
                    <label>Period Covered From To</label>
                    <input type="text" class="form-control" asp-for="date" name="date" id="fromTo" onchange="FromToCheck()"/>
                </div>
                <div class="row">
                <label class="col-sm-2"></label>
                    <div class="col-sm-10">
                    <p id="FromToCheck" />
                    </div>
                </div>
            </div>

            <div>
                <div class="col-md-3" name="hidden-panel7" id="hidden-panel7">
                    <div class="form-group">
                        <label>S.O #:</label>
                        <input type="text" asp-for="SoNumber" id="so" class="form-control" onchange="SoCheck()"/>
                    </div>
                    <div class="row">
                        <label class="col-sm-2"></label>
                        <div class="col-sm-10">
                        <p id="SoCheck" />
                        </div>
                    </div>
                </div>
                <div class="col-md-3" name="hidden-panel8" id="hidden-panel8">
                    <div class="form-group">
                        <label>TRAVEL PERIOD:</label>
                        <input type="text" name="travel_period" asp-for="travel_period"  class="form-control">
                    </div>
                </div>
                <div class="col-md-3" name="hidden-panel9" id="hidden-panel9">
                    <div class="form-group">
                        <label>ACCOUNT #:</label>
                        <input type="text" asp-for="AccountNumber" id="accNo" class="form-control" onchange="AccNoCheck()"/>
                    </div>
                    <div class="row">
                        <label class="col-sm-2"></label>
                        <div class="col-sm-10">
                        <p id="AccNoCheck" />
                        </div>
                    </div>
                </div>
                <div class="col-md-3" name="hidden-panel10" id="hidden-panel10">
                    <div class="form-group">
                        <label># OF BILLING: (FIRST, SECOND):</label>
                        <input type="text" asp-for="NumberOfBill" class="form-control" />
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12" style="margin-top: 40px;">
            <div class="col-md-2" style="width: 250px; ">
                <div class="form-group" style="margin-left: 100px; margin-top: 5px;">
                    <label style="font-weight:bold;">GROSS AMOUNT: </label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control" id="gross_amount" type="number" asp-for="GrossAmount" placeholder="0.00" onchange="computeNetAmount()" />
                </div>
            </div>
        </div>
        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[0].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[0].Amount"  placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[1].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[1].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[2].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[2].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[3].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[3].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[4].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[4].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12" onchange="submitDeduction(this);">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[5].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[5].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <div class="col-md-2" style="width: 250px;">
                <select asp-items="ViewBag.DeductionId" asp-for="indexDeductions[6].DeductionId" class="form-control select2">
                    <option value=""> - Select Deduction - </option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control deduction_amount" asp-for="indexDeductions[6].Amount" placeholder="0.00" />
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="col-md-2" style="width: 250px;">
                <div class="form-group" style="margin-left: 80px; margin-top: 5px;">
                    <label style="font-weight:bold;">TOTAL DEDUCTIONS: </label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control" type="text" id="total_deduction" placeholder="0.00" readonly />
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <div class="col-md-2" style="width: 250px;">
                <div class="form-group" style="margin-left: 120px; margin-top: 5px;">
                    <label style="font-weight:bold;">NET AMOUNT: </label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <input class="form-control" type="text" id="net_amount" placeholder="0.00" readonly />
                </div>
                <input type="submit" id="btnsubmit" value="Submit" class="btn btn-success btn-sm " />
            </div>
        </div>
    </form>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />


<script>
    //po number
    function DataCheck() {
        $("#Status").html("Checking...");
        $.post("@Url.Action("CheckifExist", "IndexOfPayment")",
            {
                userdata: $("#poNumber").val()
            },
        function (data) {
            if (data == 0) {
                $("#Status").html('<font color="Green">Po Number is available</font>');
                $("#poNumber").css("border-color", "Green");

            }
            else {
                $("#Status").html('<font color="Red">Po Number Already Exist!</font>');
                $("#poNumber").css("border-color", "Red");
            }
        });
    }
    //invoice number
    function InvoiceCheck() {
        $("#InvoiceCheck").html("Checking...");
        $.post("@Url.Action("CheckInvoiceExist", "IndexOfPayment")",
            {
                invoice: $("#invoice").val()
            },
        function (data) {
            if (data == 0) {
                $("#InvoiceCheck").html('<font color="Green">Invoice Number is available</font>');
                $("#invoice").css("border-color", "Green");

            }
            else {
                $("#InvoiceCheck").html('<font color="Red">Invoice Number Already Exist!</font>');
                $("#invoice").css("border-color", "Red");
            }
        });
    }
    //period cover
    function PeriodCheck() {
        $("#PeriodCheck").html("Checking...");
        $.post("@Url.Action("CheckPeriodExist", "IndexOfPayment")",
            {
                periodCover: $("#periodCover").val()
            },
        function (data) {
            if (data == 0) {
                $("#PeriodCheck").html('<font color="Green">Available</font>');
                $("#periodCover").css("border-color", "Green");

            }
            else {
                $("#PeriodCheck").html('<font color="Red">Already Exist!</font>');
                $("#periodCover").css("border-color", "Red");
            }
        });
    }
    //project id
    function ProjectCheck() {
        $("#ProjectCheck").html("Checking...");
        $.post("@Url.Action("CheckProjectExist", "IndexOfPayment")",
            {
                project: $("#project").val()
            },
        function (data) {
            if (data == 0) {
                $("#ProjectCheck").html('<font color="Green">Available</font>');
                $("#project").css("border-color", "Green");

            }
            else {
                $("#ProjectCheck").html('<font color="Red">Already Exist!</font>');
                $("#project").css("border-color", "Red");
            }
        });
    }
    //from to
    function FromToCheck() {
        $("#FromToCheck").html("Checking...");
        $.post("@Url.Action("CheckFromToExist", "IndexOfPayment")",
            {
                fromTo: $("#fromTo").val()
            },
        function (data) {
            if (data == 0) {
                $("#FromToCheck").html('<font color="Green">Available</font>');
                $("#fromTo").css("border-color", "Green");

            }
            else {
                $("#FromToCheck").html('<font color="Red">Already Exist!</font>');
                $("#fromTo").css("border-color", "Red");
            }
        });
    }
    //So
    function SoCheck() {
        $("#SoCheck").html("Checking...");
        $.post("@Url.Action("CheckSoExist", "IndexOfPayment")",
            {
                so: $("#so").val()
            },
        function (data) {
            if (data == 0) {
                $("#SoCheck").html('<font color="Green">Available</font>');
                $("#so").css("border-color", "Green");

            }
            else {
                $("#SoCheck").html('<font color="Red">Already Exist!</font>');
                $("#so").css("border-color", "Red");
            }
        });
    }
    //Account Number
    function AccNoCheck() {
        $("#AccNoCheck").html("Checking...");
        $.post("@Url.Action("CheckAccNoExist", "IndexOfPayment")",
            {
                accNo: $("#accNo").val()
            },
        function (data) {
            if (data == 0) {
                $("#AccNoCheck").html('<font color="Green">Available</font>');
                $("#accNo").css("border-color", "Green");

            }
            else {
                $("#AccNoCheck").html('<font color="Red">Already Exist!</font>');
                $("#accNo").css("border-color", "Red");
            }
        });
    }
</script>
<script>
    $(function () {
        $('input[name="date"]').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });
        $('input[name="date"]').on('apply.daterangepicker', function (ev, picker) {
            $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            var data = {
                date: picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY')
            };
        });

        $('input[name="date"]').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
    });

    $(function () {
        $('input[name="travel_period"]').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });
        $('input[name="travel_period"]').on('apply.daterangepicker', function (ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            var data = {
                travel_period: picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY')
            };
        });

        $('input[name="travel_period"]').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
    });


    $('.select2').select2();

    $(document).ready(function () {
        $('.prexcDropdown').select2();
    });
    get_sbu();

    function get_sbu() {
        var selected_val = $('#ddlBranches').find(":selected").attr('value');
        $.ajax({
            type: "POST",
            url: '@Url.Action("selectAT", "IndexOfPayment")',
            data: "id=" + selected_val,
            success: function (data) {
                if (data.length > 0) {
                    $('#payeeDesc').val(data[0].payeeDesc);
                    $('#particulars').val(data[0].particulars);
                    $('#date').val(data[0].date);
                }
                else {
                    $('#payeeDesc').val('');
                    $('#particulars').val('');
                }
            }
        });
    }



    function submitDeduction(parentDiv) {
        let dvDeduction = $(parentDiv).find('select');
        let dvDedectionAmt = $(parentDiv).find('input');

        if (dvDeduction.val() && dvDedectionAmt.val()) {
            console.log(dvDeduction.val(), dvDedectionAmt.val());
        }
        computeNetAmount();

    }

    function computeNetAmount() {
        let amounts = $('.deduction_amount');
        let gross_amount = +$('#gross_amount').val();
        let total = 0;
        $(amounts).each(function (index, value) {
            total += +value.value;
        });

        $('#total_deduction').val(total);
        $('#net_amount').val(gross_amount - total);
    }


    $("#CategoryId").trigger("click");
    $(document).ready(function () {
        for (i = 1; i <= 10; i++) {
            $('#hidden-panel' + i).hide();
        }
    });

     $("#CategoryId").on('change', function () {
        var value = $(this).val();
        console.log(value);
        const categ = [];
         if (value == 1) {
             $("#hidden-panel1").show();
             $("#hidden-panel5").show();
             categ.push('2', '3', '4', '6', '7', '8', '9', '10');
         } else if (value == 2 || value == 3) {
             $("#hidden-panel1").show();
             $("#hidden-panel4").show();
             categ.push('2', '5', '6', '7', '8', '9', '10');
         } else if (value == 4 ) {
             $("#hidden-panel1").show();
             categ.push('2', '4', '5', '6', '7', '8', '9', '10');
         } else if (value == 5) {
             $("#hidden-panel2").show();
             $("#hidden-panel10").show();
             categ.push('1', '3', '4', '5', '6', '7', '8', '9');
         } else if (value == 6 || value == 15 || value == 23 || value == 24 ||
             value == 25 || value == 26 || value == 27 || value == 28 ||
             value == 32 || value == 33 || value == 34 || value == 35) {
             $("#hidden-panel4").show();
             categ.push('1', '2', '3', '5', '6', '7', '8', '9', '10');
         } else if (value == 7) {
             $("#hidden-panel4").show();
             $("#hidden-panel10").show();
             categ.push('1', '2', '3', '5', '6', '7', '8', '9');

         } else if (value == 8 || value == 9 || value == 10 || value == 11 ||
             value == 22 || value == 30 || value == 31) {
             $("#hidden-panel6").show();
             categ.push('1', '2', '3', '4', '5', '7', '8', '9', '10');
         } else if (value == 12 || value == 19) {
             $("#hidden-panel8").show();
             $("#hidden-panel7").show();
             categ.push('1', '2', '3', '4', '5', '6', '9', '10');

         } else if (value == 13 || value == 14) {
             $("#hidden-panel7").show();
             categ.push('1', '2', '3', '4', '5', '6', '8', '9', '10');

         } else if (value == 16 || value == 17 || value == 18) {
             $("#hidden-panel6").show();
             $("#hidden-panel9").show();
             categ.push('1', '2', '3', '4', '5', '8', '10');
         } else if (value == 20 || value == 29) {
             categ.push('1', '2', '3', '4', '5', '6', '7', '8', '9', '10');

         } else if (value == 21) {
             $("#hidden-panel8").show();
             categ.push('1', '2', '3', '4', '5', '6', '7', '9', '10');
         }
             categ.forEach(function (i) {
                 $('#hidden-panel' + i).hide();
             });
         });


    $(document).ready(function () {
        $('.filter').change(function () {
            $('.filterable').each(function () {
                if ($(this).data('ref') != $('.filter').val() && $('.filter').val() != -1) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    });

    document.getElementById("textarea").value = "To payment of";


    $(function () {
        $('.date-picker').datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            dateFormat: 'MM yy',
            onClose: function (dateText, inst) {
                $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
            }
        });
    });


</script>
