@model fmis.Models.Obligation
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf

@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

<style>
    .wtHider {
        margin-bottom: 200px;
    }
</style>

<form>
    <table class="table">
        <tbody>
            <tr>
                <td class="col-sm-1"><strong>Particulars</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                    @Html.DisplayFor(model => model.Particulars)
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>Payee</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                    @Html.DisplayFor(model => model.Payee)
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>Address</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                    @Html.DisplayFor(model => model.Address)
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>Fund Source</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                  @*  @Html.DisplayFor(model => model.source_title)*@
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>PR #</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                    @Html.DisplayFor(model => model.Pr_no)
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>Total Amount</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10">
                    <strong class="obligation_amount"></strong>
                </td>
            </tr>
            <tr>
                <td class="col-sm-1"><strong>Dibursements</strong></td>
                <td class="col-sm-1"><strong>:</strong></td>
                <td class="col-sm-10"><strong id="uacs_disbursment"></strong></td>
            </tr>
        </tbody>
    </table>
</form>

<input type="hidden" class="obligation_amount_data" value="@ViewBag.obligation_amount">
<input type="hidden" class="uacs" value="@ViewBag.uacs">
<input type="hidden" id="obligation_token" value="@ViewBag.obligation_token" />
<input id="search_field2" style="float: left" type="search" hidden placeholder="Search" />
<div id="obligation_handsontable" class="hot handsontable htColumnHeaders"></div>
<br />
<div class="controls" hidden>
    <button id="export-file">Download CSV</button>
</div>

<script>

    var exp_code = 0;
    var default_token = "";
    var CHECK_AFTER_ROW = false;
    var COUNT_AFTER_ROW = 0;

    class KeyValueListEditor extends Handsontable.editors.HandsontableEditor {
        prepare(row, col, prop, td, value, cellProperties) {
            super.prepare(row, col, prop, td, value, cellProperties);

            Object.assign(this.htOptions, {
                licenseKey: 'non-commercial-and-evaluation',
                data: this.cellProperties.source,
                columns: [
                    {
                        data: '_id',
                    },
                    {
                        data: 'label',
                    }
                ],
                hiddenColumns: {
                    columns: [1],
                },
                colWidths: 500,
                beforeValueRender(value, { row, instance }) {
                    return instance.getDataAtRowProp(row, 'label');
                },
            });

            if (cellProperties.keyValueListCells) {
                this.htOptions.cells = cellProperties.keyValueListCells;
            }
            if (this.htEditor) {
                this.htEditor.destroy();
            }

            this.htEditor = new Handsontable(this.htContainer, this.htOptions);
        }

        setValue(value) {
            if (this.htEditor) {
                const index = this.htEditor.getDataAtProp('_id').findIndex(id => id === value);

                if (index !== -1) {
                    value = this.htEditor.getDataAtRowProp(index, 'label');
                    exp_code = this.htEditor.getDataAtRowProp(index, 'exp_code');
                }
            }
            super.setValue(value);
        }

        getValue() {
            const value = super.getValue();
            @* console.log(value);*@

            if (this.htEditor) {
                const labels = this.htEditor.getDataAtProp('label');
                const row = labels.indexOf(value);

                if (row !== -1) {
                    return this.htEditor.getDataAtRowProp(row, '_id');
                }
            }
            return value;
        }
    }

    const keyValueListValidator = function (value, callback) {
        let valueToValidate = value;

        if (valueToValidate === null || valueToValidate === void 0) {
            valueToValidate = '';
        }

        if (this.allowEmpty && valueToValidate === '') {
            callback(true);
        } else {
            callback(this.source.find(({ _id }) => _id === value) ? true : false);
        }
    };
    const keyValueListRenderer = function (hot, TD, row, col, prop, value, cellProperties) {
        const item = cellProperties.source.find(({ _id }) => _id === value);

        if (item) {
            value = item.label;
        }

        Handsontable.renderers.getRenderer('autocomplete').call(hot, hot, TD, row, col, prop, value, cellProperties);
    };

    Handsontable.cellTypes.registerCellType('key-value-list', {
        editor: KeyValueListEditor,
        validator: keyValueListValidator,
        renderer: keyValueListRenderer,
    });


    var obligation_id = @Html.DisplayFor(model => model.Id);
    let generateObligationAmountToken = () => {
        let s4 = () => {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

    function ajaxServerAmount(ajax_data, url) {
        $.ajax({
            type: 'POST',
            url: url,
            headers: { "RequestVerificationToken": '@GetAntiXsrfRequestToken()' },
            data: { data: ajax_data },
            success: function (output) {
                $('#loading_modal').modal('hide');
                console.log(output);
            }
        });
    }
    var obligationamount = $.parseJSON($(".obligation_amount_data").val());
    const obligation_amount_handsontable = [];
    var counter = 0;
    var obligation_amount = 0;

    $.each(obligationamount, function () {
        obligation_amount_handsontable[counter] = [this.UacsId, this.Expense_code, this.Amount, this.Total_disbursement, this.Total_net_amount, this.Total_tax_amount, this.Total_others, this.Id, this.obligation_token, this.obligation_amount_token]
        counter++;
        obligation_amount += this.Amount;
    })
    $(".obligation_amount").html(obligation_amount);
    console.log(obligation_amount_handsontable);

    var uacs = $.parseJSON($(".uacs").val());
    var uacs_data = []
    var uacs_counter = 0;
    $.each(uacs, function () {
        var json_data = new Object();
        json_data._id = this.UacsId;
        json_data.label = this.Account_title;
        json_data.exp_code = this.Expense_code;
        uacs_data[uacs_counter] = json_data;
        uacs_counter++;
    });

    const container = document.getElementById('obligation_handsontable');
    const hot = new Handsontable(container, {
        data: obligation_amount_handsontable,
        rowHeaders: true,
        colWidths: [300, 150, 150, 150, 150, 150, 150],
        colHeaders: ['EXPENSE TITLE', 'CODE', 'AMOUNT', 'TOTAL DISBURSEMENT', 'TOTAL NET AMOUNT', 'TOTAL TAX AMOUNT', 'TOTAL OTHERS', 'ID', 'TOKEN'],
        columns: [
            {

            },
            {
                type: 'text',
                readOnly: true,
            },
            {
                type: 'numeric',
                numericFormat: {
                    pattern: '0,0.00',
                    culture: 'en-Ph'
                },
            },
            {
                type: 'numeric',
                numericFormat: {
                    culture: 'en-Ph'
                },
                readOnly: true
            },
            {
                type: 'numeric',
                numericFormat: {
                    @*pattern: '0,0.00',*@
                    culture: 'en-Ph'
                },
                readOnly: true
            },
            {
                type: 'numeric',
                numericFormat: {
                    culture: 'en-Ph'
                },
                readOnly: true
            },
            {
                type: 'numeric',
                numericFormat: {
                },
                readOnly: true
            },
            {
                //HIDDEN ID
            },
            {
                //HIDDEN TOKEN
            },
        ],
        stretchH: 'all',
        height: 'auto',
        contextMenu: ['row_above', 'row_below', 'remove_row'],
        beforeRemoveRow: function (index, column) {
            var selection = this.getSelected();
            var holder_data = this.getData();
            var single_token = holder_data[selection[0][0]][8];
            console.log(selection);
            console.log(holder_data);
            console.log(column);
            var first_column = selection[0][0];
            var last_column = selection[0][2];
            console.log(first_column);
            console.log(last_column);
            var many_token = [];
            for (var j = first_column; j <= last_column; j++) {
                many_token.push({
                    many_token: holder_data[j][8]
                })
            }
            if (single_token) {
                var ajax_data = {
                    "single_token": single_token,
                    "many_token": many_token,
                };
               @* console.log(ajax_data);*@
                ajaxServerAmount(ajax_data,'@Url.Action("DeleteObligationAmount", "ObligationAmount")');
            }
        },
        afterUndo: function (index, column) {
        },
        afterCreateRow: function (row, column) {
            CHECK_AFTER_ROW = true; //make true taga add sa row para dile ma save sa db
            COUNT_AFTER_ROW = 2;
            hot.setDataAtCell(row, 7, $("#obligation_token").val());
            hot.setDataAtCell(row, 8, generateObligationAmountToken());
        },
        afterChange(changes) {
            if (!changes || CHECK_AFTER_ROW || COUNT_AFTER_ROW > 0) {
                CHECK_AFTER_ROW = false;
                COUNT_AFTER_ROW--;
                console.log("View Here!");
                return;
            }
            console.log("Check Here!");
            changes.forEach(([row, col, oldValue, newValue]) => {
            if (exp_code == newValue)
                return;
                if (col == 0) {
                    var ajax_data = [];
                    $(".obligation_amount").html();
                    obligation_amount = 0;
                    hot.setDataAtCell(row, col + 1, exp_code);
                    ajax_data.push({
                        ObligationId: obligation_id,
                        UacsId: hot.getDataAtCell(row, col),
                        Expense_code: hot.getDataAtCell(row, col + 1),
                        Amount: hot.getDataAtCell(row, col + 2),
                        Total_disbursement: 0,
                        Total_net_amount: 0,
                        Total_tax_amount: 0,
                        Total_others: 0,
                        obligation_token: hot.getDataAtCell(row, col + 7),
                        obligation_amount_token: hot.getDataAtCell(row, col + 8)
                    });
                    console.log(ajax_data);
                    $(".obligation_amount").html(obligation_amount);
                    ajaxServerAmount(ajax_data, '@Url.Action("SaveObligationAmount", "ObligationAmount")');
                }
                else {
                    var ajax_data = [];
                    $.each(hot.getSourceData(), function () {
                        ajax_data.push({
                            ObligationId: obligation_id,
                            UacsId: this[0] ? this[0] : "",
                            Expense_code: this[1] ? this[1] : "",
                            Amount: this[2] ? this[2] : "",
                            Total_disbursement: this[3] ? this[3] : "",
                            Total_net_amount: this[4] ? this[4] : "",
                            Total_tax_amount: this[5] ? this[5] : "",
                            Total_others: this[6] ? this[6] : "",
                            obligation_token: this[7] ? this[7] : "",
                            obligation_amount_token: this[8] ? this[8] : "",
                        });
                    });
                    console.log(hot.getSourceData());
                    console.log(ajax_data);
                    $(".obligation_amount").html(obligation_amount);
                    ajaxServerAmount(ajax_data, '@Url.Action("SaveObligationAmount", "ObligationAmount")');
                }
            });
        },
        type: 'key-value-list',
        source: uacs_data,
        hiddenColumns: {
            columns: [7,8],
            indicators: true
        },
        licenseKey: 'non-commercial-and-evaluation', // for non-commercial use only
    });

    var tableData = JSON.stringify(hot.getSourceData());
    console.log(hot.getSourceData());


</script>